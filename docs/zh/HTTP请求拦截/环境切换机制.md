# 环境感知机制

> 看到这里或许很多人就会问了，既然`mock`采用函数柯里化调用方式，那我想调用真实接口怎么办？不着急，`axios-plus`已经为你们想到了这一点。

axios-plus 提供了环境感知机制，能够根据当前运行环境自动识别并切换请求处理策略——当环境不匹配预设条件时，会自动绕过 mock 逻辑，直接发起真实接口请求，确保不同环境下的请求行为符合预期。

## 环境设置

### 1. 全局默认环境配置

框架默认通过 `process.env.NODE_ENV` 识别环境，在 `test` 环境下自动启用 mock（可通过全局配置覆盖）：

```typescript
// 框架内部默认环境判断逻辑
MockAPI.globalConfig.condition = () => {
  return process.env.NODE_ENV === 'test'; // 测试环境启用mock
};
```

### 2. 自定义环境判断逻辑

可通过 `MockAPI.setCondition` 全局配置环境判断规则，支持根据任意环境变量或运行时状态动态切换：

```typescript
// 根据自定义环境变量切换
MockAPI.setCondition(() => {
  // 开发环境且开启MOCK_MODE时启用
  return process.env.NODE_ENV === 'development' && process.env.MOCK_MODE === 'true';
});

// 结合运行时状态判断
MockAPI.setCondition(() => {
  return window.__ENABLE_MOCK__ === true; // 前端可通过全局变量动态控制
});
```

### 3. 接口级环境适配

在 `@HttpApi` 类装饰器或方法装饰器中配置 `mock.condition`，实现接口级别的环境细分：

```typescript
@HttpApi({
  baseURL: '/api',
  mock: {
    // 仅在本地开发环境启用该类下所有接口的mock
    condition: () => process.env.NODE_ENV === 'development' && location.hostname === 'localhost',
  },
})
class UserApi {
  @Get({
    url: '/profile',
    mock: {
      // 该接口仅在测试环境且用户ID为test时启用mock
      condition: () => process.env.NODE_ENV === 'test' && localStorage.getItem('userId') === 'test',
      handlers: {
        default: () => HttpResponse.json({ name: '测试用户' }),
      },
    },
  })
  getProfile() {}
}
```

## 关闭 mock

### 1. 全局关闭

通过 `MockAPI.off()` 控制全局 mock 状态，支持临时关闭和彻底关闭两种模式：

```typescript
// 临时关闭（保留拦截器，可通过on()重新开启）
MockAPI.off();

// 彻底关闭（清除所有拦截器和处理器，释放资源）
MockAPI.off(true);
```

### 2. 接口级关闭

在接口配置中通过 `mock.on` 显式关闭指定接口的 mock：

```typescript
@Get({
  url: '/sensitive-data',
  mock: {
    on: false // 强制关闭该接口的mock
  }
})
getSensitiveData() {}
```

### 3. 动态关闭

利用 `signal` 信号量在运行时动态终止 mock：

```typescript
// 创建信号控制器
const mockController = new AbortController();

@Post({
  url: '/submit',
  mock: {
    signal: mockController.signal,
    handlers: { default: () => HttpResponse.json({ success: true }) }
  }
})
submitData() {}

// 某个时机触发真实请求（如用户点击"使用真实数据"按钮）
document.getElementById('use-real-data').addEventListener('click', () => {
  mockController.abort(); // 终止mock，后续请求将走真实接口
});
```

### 4. 次数限制自动关闭

通过 `count` 配置限制 mock 生效次数，超过后自动切换到真实接口：

```typescript
@Get({
  url: '/temporary-mock',
  mock: {
    count: 3, // 仅前3次请求走mock
    handlers: { default: () => HttpResponse.json({ mock: true }) }
  }
})
getTemporaryData() {}

// 第1-3次调用：返回mock数据
// 第4次及以后：自动发起真实请求
```

### 优先级说明

环境判断与关闭逻辑的生效优先级从高到低为：

1. 信号量 `signal`（`abort()` 后立即关闭）
2. 次数限制 `count`（耗尽后关闭）
3. 接口级 `condition`（动态判断）
4. 全局 `MockAPI.off()`（全局控制）
5. 接口级 `mock.on`（显式开关）
6. 全局默认环境配置（`NODE_ENV` 判断）

这种多层级的环境感知机制，既保证了开发/测试环境中 mock 数据的便捷性，又能通过环境判断自动适配生产环境的真实接口调用，避免 mock 逻辑泄露到线上环境。
