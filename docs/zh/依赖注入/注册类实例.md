# 注册类实例

在 axios-plus 中，类实例的注册主要通过 `@Component` 装饰器结合 IoC 容器的 `InstanceFactory` 实现，用于将类纳入容器管理，支持依赖注入和生命周期控制。以下是详细的注册方式和使用说明：

## 基础注册方式

### 1. 默认注册（无配置）

通过 `@Component` 装饰器直接装饰类，容器会自动生成默认模块（`__default__`）和别名（类名首字母小写）：

```typescript
import { Component } from './core/ioc';

// 默认注册：模块为__default__，别名为"userService"
@Component
class UserService {
  getUser() {
    return { id: 1, name: 'test' };
  }
}
```

### 2. 指定模块和别名

通过装饰器参数自定义模块和别名，避免不同模块间的命名冲突：

```typescript
import { Component } from './core/ioc';

// 自定义模块和别名
@Component({
  module: 'service', // 模块名
  alias: 'userApi', // 别名
})
class UserService {
  // ...
}
```

也支持通过字符串表达式快速配置（格式：`模块.别名`）：

```typescript
// 等价于 { module: 'service', alias: 'userApi' }
@Component('service.userApi')
class UserService {
  // ...
}
```

## 注册原理

`@Component` 装饰器的核心逻辑由 `ComponentDecoratorFactory` 实现，注册过程如下：

1. 校验装饰器配置，确保无重复注册或冲突
2. 处理配置参数，生成 `InstanceRegisterConfig`（包含模块、别名、构造函数）
3. 调用 `InstanceFactory.registerInstance()` 将类信息存入容器（`instanceItemMap`）
4. 记录装饰器元数据到类上，用于后续依赖注入和 AOP 切面

## 注册约束

1. **唯一性约束**：同一模块内，不允许通过相同别名、构造函数或类名重复注册

   ```typescript
   @Component('service.user')
   class UserService {}

   // 报错：重复注册（同模块同别名）
   @Component('service.user')
   class AnotherUserService {}
   ```

2. **模块隔离**：不同模块可注册同名别名的类，彼此隔离

   ```typescript
   @Component('service1.user')
   class UserService {}

   @Component('service2.user') // 允许：不同模块
   class UserService {}
   ```

## 查看已注册实例

通过 `InstanceFactory` 的工具方法可查询容器中的实例信息：

```typescript
import { InstanceFactory } from './core/ioc/InstanceFactory';

// 获取所有非系统模块的实例
const allInstances = InstanceFactory.getInstanceItemList();

// 检查指定接口是否已注册
const hasUserService = InstanceFactory.getInstanceItemByExpression('service.userApi');
```

## 与依赖注入结合

注册后的类可通过 `@Inject` 装饰器在其他类中注入使用：

```typescript
import { Component, Inject } from './core/ioc';

@Component
class UserController {
  // 注入已注册的UserService
  @Inject('service.userApi')
  private userService: UserService;

  async getUserId() {
    const user = await this.userService.getUser();
    return user.id;
  }
}
```

通过上述方式，axios-plus 实现了类实例的统一管理，为依赖注入、AOP 切面等功能提供了基础支持，同时通过模块和别名机制保证了实例的唯一性和隔离性。
